<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
        http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <munit:config name="picking-status-test-suite" doc:name="MUnit Configuration"/>

    <!-- ========================================== -->
    <!-- Test: Successful Picking Status Publishing -->
    <!-- ========================================== -->
    <munit:test name="test-picking-status-success" 
                description="Test successful picking status event publishing" 
                doc:name="Test Picking Status Success">
        
        <munit:behavior>
            <!-- Mock Object Store contains -->
            <munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains">
                <munit-tools:then-return>
                    <munit-tools:payload value="#[false]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
            <!-- Mock Kafka publish -->
            <munit-tools:mock-when processor="kafka:publish" doc:name="Mock Kafka Publish">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Kafka_Producer_Config" attributeName="config-ref"/>
                </munit-tools:with-attributes>
            </munit-tools:mock-when>
            
            <!-- Mock Object Store store -->
            <munit-tools:mock-when processor="os:store" doc:name="Mock OS Store"/>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set Test Event">
                <munit:payload value='#[%dw 2.0 output application/json --- {
                    "pickId": "PICK-12345",
                    "warehouseId": "WH-EAST-01",
                    "poNumber": "PO-12345",
                    "status": "IN_PROGRESS",
                    "updatedAt": "2024-01-15T11:30:00Z"
                }]' mediaType="application/json"/>
            </munit:set-event>
            <flow-ref name="picking-status-implementation-flow" doc:name="Call Implementation Flow"/>
        </munit:execution>
        
        <munit:validation>
            <munit-tools:assert-that expression="#[payload.success]" is="#[MunitTools::equalTo(true)]" doc:name="Assert Success True"/>
            <munit-tools:assert-that expression="#[payload.message]" is="#[MunitTools::containsString('successfully')]" doc:name="Assert Success Message"/>
            <munit-tools:assert-that expression="#[payload.referenceId]" is="#[MunitTools::notNullValue()]" doc:name="Assert Reference ID Present"/>
            <munit-tools:assert-that expression="#[vars.httpStatus]" is="#[MunitTools::equalTo(201)]" doc:name="Assert HTTP Status 201"/>
            
            <!-- Verify Kafka was called -->
            <munit-tools:verify-call processor="kafka:publish" times="1" doc:name="Verify Kafka Called"/>
        </munit:validation>
    </munit:test>

    <!-- ========================================== -->
    <!-- Test: Picking Status Validation Error      -->
    <!-- ========================================== -->
    <munit:test name="test-picking-status-validation-error-missing-pick-id" 
                description="Test validation error when pickId is missing" 
                doc:name="Test Validation Error - Missing Pick ID"
                expectedErrorType="APP:VALIDATION_ERROR">
        
        <munit:behavior>
            <munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains">
                <munit-tools:then-return>
                    <munit-tools:payload value="#[false]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set Test Event - Missing Pick ID">
                <munit:payload value='#[%dw 2.0 output application/json --- {
                    "warehouseId": "WH-EAST-01",
                    "poNumber": "PO-12345",
                    "status": "IN_PROGRESS",
                    "updatedAt": "2024-01-15T11:30:00Z"
                }]' mediaType="application/json"/>
            </munit:set-event>
            <flow-ref name="picking-status-implementation-flow" doc:name="Call Implementation Flow"/>
        </munit:execution>
    </munit:test>

    <!-- ========================================== -->
    <!-- Test: Picking Status Validation Error - Missing Status -->
    <!-- ========================================== -->
    <munit:test name="test-picking-status-validation-error-missing-status" 
                description="Test validation error when status is missing" 
                doc:name="Test Validation Error - Missing Status"
                expectedErrorType="APP:VALIDATION_ERROR">
        
        <munit:behavior>
            <munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains">
                <munit-tools:then-return>
                    <munit-tools:payload value="#[false]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set Test Event - Missing Status">
                <munit:payload value='#[%dw 2.0 output application/json --- {
                    "pickId": "PICK-12345",
                    "warehouseId": "WH-EAST-01",
                    "poNumber": "PO-12345",
                    "updatedAt": "2024-01-15T11:30:00Z"
                }]' mediaType="application/json"/>
            </munit:set-event>
            <flow-ref name="picking-status-implementation-flow" doc:name="Call Implementation Flow"/>
        </munit:execution>
    </munit:test>

    <!-- ========================================== -->
    <!-- Test: Duplicate Picking Status             -->
    <!-- ========================================== -->
    <munit:test name="test-picking-status-duplicate" 
                description="Test duplicate message detection" 
                doc:name="Test Duplicate Message"
                expectedErrorType="MULE:DUPLICATE_MESSAGE">
        
        <munit:behavior>
            <munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains - Duplicate">
                <munit-tools:then-return>
                    <munit-tools:payload value="#[true]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set Test Event">
                <munit:payload value='#[%dw 2.0 output application/json --- {
                    "pickId": "PICK-DUPLICATE",
                    "warehouseId": "WH-EAST-01",
                    "poNumber": "PO-12345",
                    "status": "COMPLETED",
                    "updatedAt": "2024-01-15T11:30:00Z"
                }]' mediaType="application/json"/>
            </munit:set-event>
            <flow-ref name="picking-status-implementation-flow" doc:name="Call Implementation Flow"/>
        </munit:execution>
    </munit:test>

    <!-- ========================================== -->
    <!-- Test: Multiple Status Updates              -->
    <!-- ========================================== -->
    <munit:test name="test-picking-status-multiple-updates" 
                description="Test multiple status updates for same pick" 
                doc:name="Test Multiple Status Updates">
        
        <munit:behavior>
            <munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains">
                <munit-tools:then-return>
                    <munit-tools:payload value="#[false]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
            <munit-tools:mock-when processor="kafka:publish" doc:name="Mock Kafka Publish">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Kafka_Producer_Config" attributeName="config-ref"/>
                </munit-tools:with-attributes>
            </munit-tools:mock-when>
            
            <munit-tools:mock-when processor="os:store" doc:name="Mock OS Store"/>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set Test Event - Completed Status">
                <munit:payload value='#[%dw 2.0 output application/json --- {
                    "pickId": "PICK-12345",
                    "warehouseId": "WH-EAST-01",
                    "poNumber": "PO-12345",
                    "status": "COMPLETED",
                    "updatedAt": "2024-01-15T12:30:00Z"
                }]' mediaType="application/json"/>
            </munit:set-event>
            <flow-ref name="picking-status-implementation-flow" doc:name="Call Implementation Flow"/>
        </munit:execution>
        
        <munit:validation>
            <munit-tools:assert-that expression="#[payload.success]" is="#[MunitTools::equalTo(true)]" doc:name="Assert Success True"/>
            <munit-tools:verify-call processor="kafka:publish" times="1" doc:name="Verify Kafka Called"/>
        </munit:validation>
    </munit:test>

</mule>
